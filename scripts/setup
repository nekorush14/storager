#!/bin/bash

# Storager Project Setup Script
set -e

echo "ğŸ—ï¸  Storager ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
echo "=================================="

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to check version
check_version() {
    local cmd=$1
    local min_version=$2
    local current_version
    
    case $cmd in
        "node")
            current_version=$(node --version | sed 's/v//')
            ;;
        "ruby")
            current_version=$(ruby --version | awk '{print $2}')
            ;;
    esac
    
    echo "âœ… $cmd version: $current_version"
}

echo "ğŸ“‹ å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

# Check for required tools
REQUIRED_TOOLS=("node" "npm" "ruby" "bundle" "rails")
MISSING_TOOLS=()

for tool in "${REQUIRED_TOOLS[@]}"; do
    if command_exists "$tool"; then
        case $tool in
            "node") check_version "node" "18.0.0" ;;
            "ruby") check_version "ruby" "3.0.0" ;;
            *) echo "âœ… $tool is installed" ;;
        esac
    else
        MISSING_TOOLS+=("$tool")
    fi
done

if [ ${#MISSING_TOOLS[@]} -ne 0 ]; then
    echo "âŒ ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“:"
    for tool in "${MISSING_TOOLS[@]}"; do
        echo "   - $tool"
    done
    echo ""
    echo "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰:"
    echo "â€¢ Node.js (v18+): https://nodejs.org/"
    echo "â€¢ Ruby (v3.0+): https://www.ruby-lang.org/"
    echo "â€¢ Rails: gem install rails"
    echo "â€¢ Bundler: gem install bundler"
    exit 1
fi

echo ""
echo "ğŸ—„ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¦ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

# Check for PostgreSQL
if command_exists "psql"; then
    echo "âœ… PostgreSQL is installed"
else
    echo "âš ï¸  PostgreSQL ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "PostgreSQLã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"
    echo "â€¢ macOS: brew install postgresql"
    echo "â€¢ Ubuntu: sudo apt-get install postgresql postgresql-contrib"
    echo ""
    read -p "PostgreSQLãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç¶šè¡Œã—ã¾ã™ã‹? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo ""
echo "ğŸ“¦ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆRailsï¼‰ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."

if [ ! -d "backend" ]; then
    echo "âŒ Error: backend directory not found!"
    exit 1
fi

cd backend

# Install Ruby gems
echo "ğŸ’ Rubyã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
bundle install

# Setup database
echo "ğŸ—„ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
if bundle exec rails db:version &> /dev/null; then
    echo "Database already exists, running migrations..."
    bundle exec rails db:migrate
else
    echo "Creating and setting up database..."
    bundle exec rails db:create db:migrate
fi

# Seed data if seeds file exists
if [ -f "db/seeds.rb" ] && [ -s "db/seeds.rb" ]; then
    echo "ğŸŒ± ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ä¸­..."
    bundle exec rails db:seed
fi

cd ..

echo ""
echo "ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactï¼‰ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."

if [ ! -d "frontend" ]; then
    echo "âŒ Error: frontend directory not found!"
    exit 1
fi

cd frontend

# Install Node.js dependencies
echo "ğŸ“¦ Node.jsã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
npm install

cd ..

echo ""
echo "ğŸ§ª è¨­å®šã‚’ãƒ†ã‚¹ãƒˆä¸­..."

# Test backend
echo "Testing backend..."
cd backend
if timeout 10s bundle exec rails runner "puts 'Backend OK'" 2>/dev/null; then
    echo "âœ… Backend setup successful"
else
    echo "âš ï¸  Backend test timeout (this might be normal)"
fi
cd ..

# Test frontend
echo "Testing frontend..."
cd frontend
if npm run build --silent 2>/dev/null; then
    echo "âœ… Frontend setup successful"
else
    echo "âŒ Frontend build failed"
    exit 1
fi
cd ..

echo ""
echo "ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†!"
echo "==================="
echo ""
echo "ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•: ./scripts/start-backend.sh"
echo "2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•: ./scripts/start-frontend.sh (åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«)"
echo ""
echo "ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹å…ˆ:"
echo "â€¢ Frontend: http://localhost:5173"
echo "â€¢ Backend API: http://localhost:3000/api/v1"
echo ""
echo "ğŸ”§ ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰:"
echo "â€¢ Backend tests: cd backend && bundle exec rspec"
echo "â€¢ Frontend tests: cd frontend && npm test"
echo "â€¢ Code quality: cd backend && bundle exec rubocop"
echo ""
echo "Happy coding! ğŸš€"